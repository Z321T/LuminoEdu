# 系统认证流程详解

## 核心组件关系

这些文件共同实现了一个完整的用户认证和授权系统，采用了JWT (JSON Web Token) 机制。下面是各组件之间的关系与工作流程：

### 1. 项目结构与路由配置

- `main.py`: 应用入口，创建FastAPI实例并注册主路由
- `routers/__init__.py`: 定义API路由层次结构，将认证路由(`auth.router`)挂载到主路由下的`/auth`前缀

```
客户端请求 → main.py → api_router → auth.router → 具体的处理函数
```

### 2. 用户模型与角色体系

- `models/user_common.py`: 定义了抽象基类`UserBase`和角色枚举`UserRole`
- 所有用户类型(学生、教师、管理员)继承自`UserBase`，共享通用功能:
  - 密码加密存储(`set_password`)
  - 密码验证(`verify_password`) 
  - 权限检查(`has_permission`)

### 3. 认证数据模型

- `schemas/auth.py`: 使用Pydantic定义API数据结构:
  - `LoginForm`: 登录请求数据模型
  - `Token`: 登录成功后的响应模型
  - `TokenPayload`: JWT令牌负载结构

### 4. 完整登录认证流程

1. **用户请求登录**:
   - 客户端发送POST请求到`/auth/login`，携带用户名、密码和角色
   - 请求由`auth.py`中的`login`函数接收并转发至`login_for_access_token`

2. **用户身份验证**:
   - `authenticate_user`函数根据角色选择对应的用户模型
   - 验证用户存在性、密码正确性和角色匹配性

3. **生成访问令牌**:
   - 身份验证成功后，`create_access_token`函数创建JWT令牌
   - 令牌中包含用户ID、用户名和角色信息
   - 使用`TokenPayload`模型确保令牌数据结构一致

4. **返回认证结果**:
   - 返回包含访问令牌、用户ID、角色等信息的响应

### 5. 受保护资源访问流程

1. **请求包含JWT**:
   - 客户端请求受保护资源（如`/auth/me`），在Header中携带JWT

2. **令牌验证与用户恢复**:
   - `get_current_user`依赖项自动执行
   - 调用`verify_token`解析并验证JWT令牌
   - 通过`get_user_by_role_and_id`获取完整用户对象

3. **授权访问资源**:
   - 令牌有效，用户存在，则API端点获取当前用户信息并继续处理请求

## 代码优势

1. **模块化设计**: 每个组件有明确的单一职责
2. **多角色支持**: 灵活的用户模型继承体系
3. **功能分离**: 路由处理、业务逻辑和数据访问清晰分离
4. **类型安全**: 使用Pydantic模型确保数据结构一致性
5. **安全认证**: JWT实现的无状态认证机制

这种设计使系统易于维护和扩展，为教学管理系统提供了可靠的用户认证基础。